---
title: "Downloading data demo"
author: "Rebecca Ferrell"
date: "May 4, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

Our goal is to download, import, and clean up the files posted at [California Office of Statewide Health Planning and Development Hospital Quarterly Financial and Utilization Data Files](http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/CmpleteData/default.asp) from 2000-2015. The end result should be a data frame with one row per hospital per quarter. The data of interest are provided in files grouped annually for 2000-2015.

# Strategy

Let's examine the URLs to identify patterns and figure out a good way to loop.

* 2015: <http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/Qtr2015/2015_R4_Q4.xls>
* 2014: <http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/Qtr2014/2014_R4_Q4.xls>
* 2013: <http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/Qtr2013/2013_Q4R4.xls>
* 2012: <http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/Qtr2012/2012R4_Q4.xls>
* 2011: <http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/Qtr2011/2011R4_Q4.xls>
* 2010: <http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/Qtr2010/2010_Q4R4_Rev2.xls>
* 2009: <http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/Qtr2009/2009_Q4R4.xls>
* 2008: <http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/Qtr2008/2008Q4R4_Revised.xls>
* 2007: <http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/Qtr2007/2007_Q4R4.xls>
* 2006: <http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/Qtr2006/2006_Q4R4.xls>
* 2005: <http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/Qtr2005/2005_R4Q4_Rev5-07.xls>
* 2004: <http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/Qtr2004/2004_R4Q4_Rev5-07.xls>
* 2003: <http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/Qtr2003/2003_R4QR_Rev5-07.xls>
* 2002: <http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/Qtr2002/2002_R4Q4_Rev5-07.xls>
* 2001: <http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/Qtr2001/2001_R4Q4_Rev5-07_1.xls>
* 2000: <http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/Qtr2000/2000_R4Q4_Rev5-07.xls>

What I observe:

* All files are inside a directory of the form `http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/Qtr[YEAR]` where we replace `[YEAR]` with the appropriate year.
* All files have extension `.xls`.
* Files for 2000-2005 are named in pattern `[YEAR]_R4Q4_Rev5-07`, *except* someone made a typo in doing this for 2003: `2003_R4QR_Rev5-07`. Oops!
* Files for 2006, 2007, and 2009 are named in pattern `[YEAR]_Q4R4`.
* File for 2008 named `2008Q4R4_Revised`.
* File for 2010 named `2010_Q4R4_Rev2`.
* File for 2011 and 2012 named `[YEAR]R4_Q4`. 
* File for 2013 named `2013_Q4R4`. You know, consistency, who really cares right?
* File for 2014 and 2015 named `[YEAR]_R4_Q4`.
* Place your bets on the file name for 2016!

What would make sense here is to use a bit of looping to generate these URLs without a ton of copy/pasting. Then when I download these spreadsheets, I'll rename the files something better and consistent for posterity: `CA_OSHPHD_utilization_[YEAR].xls`. I'll then pre-allocate a list to store each of the files when I read them into R, and then I can use `bind_rows` in `dplyr` to squish them from being annual data sets inside a list to one big data frame.

```{r, eval=FALSE}
# install.packages("readxl")
library(readxl)
base_url <- "http://oshpd.ca.gov/hid/Products/Hospitals/QuatrlyFinanData/"
extension <- ".xls"
# will have 2000-2015 = 16 years total
ca_hosp_annual <- vector("list", 16)
for(year in 2000:2015) {
    if(year == 2015) {
        for(qtr in 1:3) {
            temp_file <- download.file(url = paste0(base_url, "Qtr2015/2015_Q", qtr, extension), destfile = paste0("2015_Q", qtr, extension), mode = "wb")
        }
    }
    
}
# annual URLs (2000-2014)
indiv_urls <- c("2015/2015_Q3", "2014/2014_Q2", "2014/2014_Q2")


```

making a vector of file names for data chunked, then an empty list, then populating with data read in using list names, then using bind_rows on the list to put it all together, and cleaning up everything (rm, dir.create, deleting folders with unlink)

if and else as conditional modifiers, e.g. say data before one year were structured one way and data after a different way
